<html>
<header>
<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />

<script type="text/javascript">
    function parseQuery() {
	var qs = window.location.search.substring(1).split("&");
	this.qs = new Array();
	for (var i=0; i<qs.length; i++)
	{
	    pair = qs[i].split('=');
	    this.qs[pair[0]] = pair.length > 1 ? decodeURIComponent(pair[1]) : "";
	}
    }

    function loadImg() {
	var snapurl = "/osb/session/snapshot?session_id=" + this.qs["session_id"];
	var xhr = new XMLHttpRequest();
	xhr.open( "GET", snapurl, true );
	xhr.responseType = "arraybuffer";
	xhr.timeout = 500;
	xhr.ontimeout = function( e ) {
	    console.log("Timeout loading image");
	    setTimeout(function () { loadImg() }, 0);
	}
	xhr.onerror = function( e ) {
	    console.log("Error loading image");
	    setTimeout(function () { loadImg() }, 0);
	}
	xhr.onabort = function( e ) {
	    console.log("Aborted loading image load");
	}
	xhr.onload = function( e ) {
	    if (xhr.readyState != 4 || xhr.status != 200) { 
		console.error(xhr.statusText);
		setTimeout(function () { loadImg() }, 0);
                return;
	    }
	    setTimeout(function () { loadImg() }, 10);
	    var arrayBufferView = new Uint8Array( this.response );
	    var blob = new Blob( [ arrayBufferView ], { type: "image/jpeg" });
	    var urlCreator = window.URL || window.webkitURL;
	    var imageUrl = urlCreator.createObjectURL( blob );
	    var img = document.querySelector( "#snap-img" );
	    img.src = imageUrl;
	};
	xhr.send();
    }
    parseQuery();
</script>
</header>

<body onload="loadImg()" style="margin:0">
<img id="snap-img"></img>
</body>
</html>
